<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Menu Calendar â€” Culinary Block Collective</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --green:        #2D6A4F;
      --dgreen:       #1B4332;
      --lgreen:       #EAF2EB;
      --gold:         #C9992A;
      --gold-light:   #F0DFA0;
      --lgold:        #FBF5E6;
      --cream:        #FAF7F2;
      --cream2:       #F3EDE4;
      --border:       #E2D9CE;
      --text:         #1C1814;
      --muted:        #5C5349;
      --white:        #FFFFFF;
      --radius:       10px;
      --shadow:       0 4px 32px rgba(43,28,12,0.10);
      --shadow-lg:    0 12px 48px rgba(43,28,12,0.14);
      --font-display: 'Cormorant Garamond', Georgia, serif;
      --font-body:    'Inter', system-ui, sans-serif;
    }
    html { scroll-behavior: smooth; }
    body { font-family: var(--font-body); color: var(--text); background: var(--cream); line-height: 1.6; }
    a { color: inherit; text-decoration: none; }

    /* â”€â”€ NAV â”€â”€ */
    nav {
      position: sticky; top: 0; z-index: 100;
      background: var(--dgreen); padding: 0 24px;
      display: flex; align-items: center; justify-content: space-between;
      height: 62px; border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .nav-logo { font-family: var(--font-display); color: var(--white); font-weight: 600; font-size: 1.2rem; letter-spacing: .02em; }
    .nav-logo span { color: var(--gold); }
    .nav-links { display: flex; align-items: center; gap: 6px; }
    .nav-link {
      color: rgba(255,255,255,0.7); font-size: 0.88rem; font-weight: 500;
      padding: 7px 14px; border-radius: 4px; transition: background .15s, color .15s;
    }
    .nav-link:hover { background: rgba(255,255,255,0.1); color: var(--white); }
    .nav-link.active { background: rgba(255,255,255,0.12); color: var(--white); }

    /* â”€â”€ CALENDAR WRAPPER â”€â”€ */
    .cal-page { max-width: 1440px; margin: 0 auto; padding: 24px 24px 60px; }

    /* â”€â”€ CONTROLS â”€â”€ */
    .cal-controls {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .cal-title { font-family: var(--font-display); font-size: 1.8rem; font-weight: 600; color: var(--dgreen); min-width: 220px; }
    .btn-nav {
      font-family: var(--font-body); font-size: 1.2rem; font-weight: 700;
      width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--white); color: var(--dgreen); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background .12s, border-color .12s;
    }
    .btn-nav:hover { background: var(--lgold); border-color: var(--gold); }
    .btn-today {
      font-family: var(--font-body); font-size: 0.84rem; font-weight: 700;
      padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--white); color: var(--dgreen); cursor: pointer;
      transition: background .12s;
    }
    .btn-today:hover { background: var(--lgold); }
    .view-toggle { display: flex; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
    .view-btn {
      font-family: var(--font-body); font-size: 0.82rem; font-weight: 600;
      padding: 8px 16px; border: none; cursor: pointer; background: var(--white);
      color: var(--muted); transition: background .12s, color .12s;
    }
    .view-btn.active { background: var(--dgreen); color: var(--white); }
    .controls-right { display: flex; gap: 10px; align-items: center; margin-left: auto; flex-wrap: wrap; }
    .filter-label { font-size: 0.78rem; font-weight: 700; letter-spacing: .06em; text-transform: uppercase; color: var(--muted); }
    .ctrl-select {
      font-family: var(--font-body); font-size: 0.84rem;
      border: 1px solid var(--border); border-radius: 8px;
      padding: 8px 12px; background: var(--white); color: var(--text);
      outline: none; transition: border-color .15s; cursor: pointer;
    }
    .ctrl-select:focus { border-color: var(--green); }

    /* â”€â”€ CAL BODY â”€â”€ */
    .cal-body {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 20px;
      align-items: start;
    }

    /* â”€â”€ MONTH GRID â”€â”€ */
    .cal-grid-wrap { min-width: 0; }
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .cal-day-header {
      background: var(--dgreen); color: rgba(255,255,255,0.85);
      text-align: center; padding: 10px 4px;
      font-size: 0.72rem; font-weight: 700;
      letter-spacing: .08em; text-transform: uppercase;
    }
    .cal-cell {
      background: var(--white); min-height: 110px; padding: 8px;
      cursor: pointer; transition: background .12s;
      position: relative;
    }
    .cal-cell:hover { background: var(--lgold); }
    .cal-cell.today { outline: 2px solid var(--gold); outline-offset: -2px; }
    .cal-cell.selected { background: var(--lgreen); }
    .cal-cell.selected:hover { background: #D4EDD9; }
    .cal-cell.other-month { background: var(--cream2); }
    .cal-cell.other-month .cal-date-num { color: var(--muted); opacity: 0.5; }
    .cal-cell.empty { background: var(--cream2); cursor: default; }
    .cal-date-num {
      font-size: 0.82rem; font-weight: 700; color: var(--text);
      margin-bottom: 5px; display: flex; align-items: center; gap: 4px;
    }
    .today-pill {
      background: var(--gold); color: var(--dgreen);
      font-size: 0.62rem; font-weight: 800; padding: 1px 6px;
      border-radius: 50px; letter-spacing: .04em;
    }
    .cal-dots { display: flex; gap: 3px; flex-wrap: wrap; margin-bottom: 4px; }
    .cal-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .cal-item-count { font-size: 0.68rem; color: var(--muted); }

    /* â”€â”€ WEEK VIEW â”€â”€ */
    .week-grid {
      display: grid; grid-template-columns: repeat(7,1fr);
      gap: 10px;
    }
    .week-col {
      background: var(--white); border-radius: var(--radius);
      border: 1px solid var(--border); overflow: hidden;
      box-shadow: var(--shadow); cursor: pointer;
      transition: box-shadow .15s;
    }
    .week-col:hover { box-shadow: var(--shadow-lg); }
    .week-col.today { border-color: var(--gold); border-width: 2px; }
    .week-col.selected { background: var(--lgreen); }
    .week-col-header {
      background: var(--dgreen); color: var(--white);
      text-align: center; padding: 10px 6px;
    }
    .week-col-dayname { font-size: 0.7rem; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; opacity: 0.75; }
    .week-col-date { font-family: var(--font-display); font-size: 1.4rem; font-weight: 600; line-height: 1; margin-top: 2px; }
    .week-col-body { padding: 10px 8px; }
    .week-item {
      display: flex; align-items: flex-start; gap: 6px;
      padding: 5px 0; border-bottom: 1px solid var(--border); font-size: 0.75rem;
    }
    .week-item:last-child { border: none; }
    .week-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 3px; flex-shrink: 0; }
    .week-item-name { font-weight: 600; color: var(--text); }
    .week-empty { font-size: 0.75rem; color: var(--muted); padding: 8px 0; text-align: center; }

    /* â”€â”€ DETAIL PANEL â”€â”€ */
    .cal-panel {
      background: var(--white); border-radius: var(--radius);
      border: 1px solid var(--border); padding: 0;
      position: sticky; top: 80px;
      max-height: calc(100vh - 110px); overflow-y: auto;
      box-shadow: var(--shadow);
    }
    .panel-header {
      background: var(--dgreen); color: var(--white);
      padding: 20px 20px 16px; border-radius: var(--radius) var(--radius) 0 0;
      position: sticky; top: 0; z-index: 10;
    }
    .panel-date { font-family: var(--font-display); font-size: 1.4rem; font-weight: 600; color: var(--white); }
    .panel-meta { font-size: 0.78rem; color: rgba(255,255,255,0.65); margin-top: 2px; }
    .panel-filters { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .panel-filter-select {
      font-family: var(--font-body); font-size: 0.75rem;
      border: 1px solid rgba(255,255,255,0.25); border-radius: 6px;
      padding: 5px 8px; background: rgba(255,255,255,0.1); color: var(--white);
      outline: none; cursor: pointer;
    }
    .panel-filter-select option { background: var(--dgreen); }
    .panel-body { padding: 16px 20px; }
    .panel-empty {
      text-align: center; padding: 40px 20px;
      color: var(--muted); font-size: 0.88rem;
    }
    .panel-empty .empty-icon { font-size: 2rem; margin-bottom: 10px; }
    .panel-no-day {
      text-align: center; padding: 48px 20px;
      color: var(--muted); font-size: 0.88rem;
    }
    .panel-cuisine-section { margin-bottom: 20px; }
    .panel-cuisine-header {
      display: flex; align-items: center; gap: 8px;
      font-family: var(--font-display); font-size: 1.05rem; font-weight: 600;
      color: var(--dgreen); padding: 6px 0 8px;
      border-bottom: 2px solid var(--border); margin-bottom: 6px;
    }
    .panel-cuisine-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .panel-cuisine-count { font-size: 0.72rem; font-weight: 600; margin-left: auto; color: var(--muted); font-family: var(--font-body); }
    .panel-item { padding: 10px 0; border-bottom: 1px solid var(--border); }
    .panel-item:last-child { border: none; }
    .panel-item-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
    .panel-item-name { font-weight: 700; font-size: 0.88rem; color: var(--text); }
    .panel-item-price { font-family: var(--font-display); font-size: 1rem; font-weight: 600; color: var(--dgreen); white-space: nowrap; }
    .panel-item-desc { font-size: 0.77rem; color: var(--muted); margin-top: 3px; line-height: 1.4; }
    .panel-item-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
    .tag-dietary {
      display: inline-block; padding: 2px 7px; border-radius: 4px;
      font-size: 0.65rem; font-weight: 700;
      background: var(--lgreen); color: var(--dgreen);
    }
    .tag-tier {
      display: inline-block; padding: 2px 7px; border-radius: 4px;
      font-size: 0.65rem; font-weight: 700;
      background: var(--lgold); color: #7A5C0A;
    }

    /* â”€â”€ BOOK BUTTON â”€â”€ */
    .panel-book-wrap {
      padding: 16px 20px 20px;
      border-top: 1px solid var(--border);
      background: var(--cream2);
    }
    .btn-book-date {
      display: block; width: 100%; text-align: center;
      background: var(--green); color: var(--white);
      font-family: var(--font-body); font-size: 0.9rem; font-weight: 700;
      padding: 13px 20px; border-radius: 8px;
      text-decoration: none; letter-spacing: 0.02em;
      transition: background .15s, transform .1s;
    }
    .btn-book-date:hover { background: var(--dgreen); transform: translateY(-1px); }
    .btn-book-subtext {
      text-align: center; font-size: 0.72rem; color: var(--muted);
      margin-top: 7px;
    }

    /* â”€â”€ LEGEND â”€â”€ */
    .legend {
      display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 16px;
    }
    .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: var(--muted); }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    /* â”€â”€ RESPONSIVE â”€â”€ */
    @media (max-width: 1000px) {
      .cal-body { grid-template-columns: 1fr; }
      .cal-panel { position: static; max-height: none; }
    }
    @media (max-width: 640px) {
      .cal-controls { gap: 6px; }
      .controls-right { margin-left: 0; }
      .cal-title { font-size: 1.4rem; min-width: 160px; }
      .week-grid { grid-template-columns: repeat(7,1fr); gap: 4px; }
      .week-col-body { padding: 6px 4px; }
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-logo">Culinary Block <span>Collective</span></div>
  <div class="nav-links">
    <a class="nav-link" href="/">â† Home</a>
    <a class="nav-link" href="/admin">âš™ï¸ Admin</a>
    <a class="nav-link active" href="/calendar">ğŸ“… Calendar</a>
  </div>
</nav>

<div class="cal-page">

  <!-- CONTROLS -->
  <div class="cal-controls">
    <button class="btn-nav" id="btn-prev" title="Previous">â€¹</button>
    <button class="btn-nav" id="btn-next" title="Next">â€º</button>
    <div class="cal-title" id="cal-title">Loadingâ€¦</div>
    <button class="btn-today" id="btn-today">Today</button>
    <div class="view-toggle">
      <button class="view-btn active" id="btn-month" onclick="setView('month')">Month</button>
      <button class="view-btn" id="btn-week" onclick="setView('week')">Week</button>
    </div>
    <div class="controls-right">
      <span class="filter-label">Filter:</span>
      <select class="ctrl-select" id="ctrl-cuisine">
        <option value="">All Cuisines</option>
        <option value="sushi">Sushi</option>
        <option value="chinese">Chinese</option>
        <option value="mexican">Mexican</option>
        <option value="american">American</option>
        <option value="specialty">Specialty</option>
      </select>
      <select class="ctrl-select" id="ctrl-tier">
        <option value="">All Tiers</option>
        <option value="box_lunch">Box Lunch</option>
        <option value="buffet">Buffet</option>
        <option value="mix_match">Mix &amp; Match</option>
      </select>
    </div>
  </div>

  <!-- LEGEND -->
  <div class="legend" id="legend"></div>

  <!-- BODY: grid + panel -->
  <div class="cal-body">
    <div class="cal-grid-wrap" id="cal-grid-wrap">
      <!-- Month or week grid rendered here -->
    </div>

    <!-- DETAIL PANEL -->
    <div class="cal-panel" id="cal-panel">
      <div class="panel-no-day">
        <div style="font-size:2rem;margin-bottom:10px;">ğŸ“…</div>
        Click any day to see the full menu.
      </div>
    </div>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// A â€” SHARED DATA LAYER (read-only)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = 'cbc_menu_data';

const DEFAULT_DATA = {
  items: [
    {id:'s1',name:'Salmon Roll',description:'Fresh salmon, avocado, cucumber wrapped in seasoned rice',cuisine:'sushi',tiers:['buffet','mix_match'],price_per_person:22,dietary:['gf'],available_days:[1,2,3,4,5],active:true,sort_order:1},
    {id:'s2',name:'Tuna Sashimi',description:'Premium sliced bluefin tuna, lightly seasoned',cuisine:'sushi',tiers:['buffet','mix_match'],price_per_person:25,dietary:['gf','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:2},
    {id:'s3',name:'Bento Box',description:'Curated bento with rice, protein, pickled veg and sides',cuisine:'sushi',tiers:['box_lunch'],price_per_person:18,dietary:[],available_days:[1,2,3,4,5],active:true,sort_order:3},
    {id:'s4',name:'Miso Soup',description:'Traditional dashi-based miso with tofu and wakame',cuisine:'sushi',tiers:['box_lunch','buffet'],price_per_person:5,dietary:['vegan','gf'],available_days:[1,2,3,4,5],active:true,sort_order:4},
    {id:'s5',name:'Ramen',description:'Rich tonkotsu or shoyu broth with noodles, chashu and soft egg',cuisine:'sushi',tiers:['buffet'],price_per_person:20,dietary:[],available_days:[1,2,3,4,5],active:true,sort_order:5},
    {id:'s6',name:'Shrimp Tempura Roll',description:'Crispy tempura shrimp, cucumber, avocado with spicy mayo',cuisine:'sushi',tiers:['buffet','mix_match'],price_per_person:21,dietary:['dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:6},
    {id:'s7',name:'Edamame',description:'Steamed salted young soybeans â€” perfect starter',cuisine:'sushi',tiers:['box_lunch','buffet','mix_match'],price_per_person:4,dietary:['vegan','gf','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:7},
    {id:'c1',name:'Wok Stir-Fry',description:'Seasonal vegetables and protein stir-fried in savory Sichuan sauce',cuisine:'chinese',tiers:['buffet','mix_match'],price_per_person:18,dietary:[],available_days:[1,2,3,4,5],active:true,sort_order:1},
    {id:'c2',name:'Pork Dumplings',description:'Handmade dumplings filled with pork and napa cabbage',cuisine:'chinese',tiers:['box_lunch','buffet'],price_per_person:16,dietary:[],available_days:[1,2,3,4,5],active:true,sort_order:2},
    {id:'c3',name:'Lo Mein Noodles',description:'Stir-fried egg noodles with vegetables and choice of protein',cuisine:'chinese',tiers:['box_lunch','buffet'],price_per_person:15,dietary:['dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:3},
    {id:'c4',name:'Spring Rolls',description:'Crispy vegetable spring rolls with sweet chili dipping sauce',cuisine:'chinese',tiers:['box_lunch','buffet','mix_match'],price_per_person:14,dietary:['vegan','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:4},
    {id:'c5',name:'Kung Pao Chicken',description:'Classic Sichuan spiced chicken with peanuts and dried chilies',cuisine:'chinese',tiers:['buffet','mix_match'],price_per_person:20,dietary:['dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:5},
    {id:'c6',name:'Fried Rice',description:'Wok-fried jasmine rice with egg, vegetables, and soy sauce',cuisine:'chinese',tiers:['box_lunch','buffet'],price_per_person:14,dietary:['dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:6},
    {id:'c7',name:'Egg Drop Soup',description:'Silky egg-ribbon soup with ginger, scallions, and sesame',cuisine:'chinese',tiers:['box_lunch','buffet'],price_per_person:7,dietary:['dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:7},
    {id:'m1',name:'Street Tacos (Chicken)',description:'Grilled chicken thighs with salsa verde, cilantro, onion on corn tortilla',cuisine:'mexican',tiers:['box_lunch','buffet','mix_match'],price_per_person:16,dietary:['gf','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:1},
    {id:'m2',name:'Street Tacos (Beef)',description:'Slow-braised carne asada with pico de gallo on corn tortilla',cuisine:'mexican',tiers:['box_lunch','buffet','mix_match'],price_per_person:18,dietary:['gf','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:2},
    {id:'m3',name:'Elote',description:'Mexican street corn grilled and served with cotija, lime and chili',cuisine:'mexican',tiers:['buffet','mix_match'],price_per_person:8,dietary:['gf','nut_free'],available_days:[1,2,3,4,5],active:true,sort_order:3},
    {id:'m4',name:'Rice Bowls',description:'Cilantro lime rice with black beans, pico, guac and choice of protein',cuisine:'mexican',tiers:['box_lunch'],price_per_person:15,dietary:['gf'],available_days:[1,2,3,4,5],active:true,sort_order:4},
    {id:'m5',name:'Chips & Guac',description:'House-made tortilla chips with fresh avocado guacamole and salsa',cuisine:'mexican',tiers:['box_lunch','buffet','mix_match'],price_per_person:7,dietary:['vegan','gf','nut_free','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:5},
    {id:'m6',name:'Burrito Bar',description:'Build-your-own burritos with all toppings â€” feeds any crowd',cuisine:'mexican',tiers:['buffet','mix_match'],price_per_person:18,dietary:[],available_days:[1,2,3,4,5],active:true,sort_order:6},
    {id:'m7',name:'Horchata',description:'Chilled cinnamon-rice milk drink, house made',cuisine:'mexican',tiers:['box_lunch','buffet'],price_per_person:5,dietary:['vegan','gf','nut_free'],available_days:[1,2,3,4,5],active:true,sort_order:7},
    {id:'m8',name:'Churros',description:'Fried dough pastry with cinnamon sugar and dulce de leche dip',cuisine:'mexican',tiers:['buffet','mix_match'],price_per_person:6,dietary:['vegan'],available_days:[1,2,3,4,5],active:true,sort_order:8},
    {id:'a1',name:'Smoked Brisket',description:'Low-and-slow smoked beef brisket with house BBQ sauce',cuisine:'american',tiers:['buffet','mix_match'],price_per_person:22,dietary:['gf','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:1},
    {id:'a2',name:'BBQ Sliders',description:'Pulled pork or beef sliders with coleslaw on brioche buns',cuisine:'american',tiers:['box_lunch','buffet'],price_per_person:16,dietary:[],available_days:[1,2,3,4,5],active:true,sort_order:2},
    {id:'a3',name:'Mac & Cheese',description:'Creamy five-cheese baked mac, crispy breadcrumb topping',cuisine:'american',tiers:['box_lunch','buffet'],price_per_person:13,dietary:[],available_days:[1,2,3,4,5],active:true,sort_order:3},
    {id:'a4',name:'Cornbread',description:'Southern-style honey cornbread baked fresh, served warm',cuisine:'american',tiers:['box_lunch','buffet','mix_match'],price_per_person:5,dietary:['nut_free'],available_days:[1,2,3,4,5],active:true,sort_order:4},
    {id:'a5',name:'Pulled Pork',description:'Smoked pulled pork shoulder with vinegar slaw and pickles',cuisine:'american',tiers:['buffet','mix_match'],price_per_person:18,dietary:['gf','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:5},
    {id:'a6',name:'Coleslaw',description:'Creamy shredded cabbage and carrot slaw with apple cider dressing',cuisine:'american',tiers:['box_lunch','buffet'],price_per_person:5,dietary:['gf','nut_free'],available_days:[1,2,3,4,5],active:true,sort_order:6},
    {id:'a7',name:'Peach Cobbler',description:'Warm Southern peach cobbler with oat crumble and vanilla cream',cuisine:'american',tiers:['buffet','mix_match'],price_per_person:8,dietary:['nut_free'],available_days:[1,2,3,4,5],active:true,sort_order:7},
    {id:'sp1',name:'Grain Bowl',description:'Quinoa and farro base with roasted chickpeas, greens and tahini dressing',cuisine:'specialty',tiers:['box_lunch'],price_per_person:18,dietary:['vegan','gf','nut_free','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:1},
    {id:'sp2',name:'Roasted Veggie Platter',description:'Seasonal roasted vegetables with herb dips and pita',cuisine:'specialty',tiers:['box_lunch','buffet'],price_per_person:16,dietary:['vegan','nut_free'],available_days:[1,2,3,4,5],active:true,sort_order:2},
    {id:'sp3',name:'Vegan Curry',description:'Slow-simmered coconut curry with seasonal vegetables and brown rice',cuisine:'specialty',tiers:['buffet','mix_match'],price_per_person:18,dietary:['vegan','gf','nut_free','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:3},
    {id:'sp4',name:'GF Pasta Salad',description:'Gluten-free rotini with cherry tomatoes, olives, basil and lemon vinaigrette',cuisine:'specialty',tiers:['box_lunch'],price_per_person:15,dietary:['vegan','gf','nut_free','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:4},
    {id:'sp5',name:'Seasonal Soup',description:'Chef-driven seasonal soup, changes weekly â€” always vegan and GF',cuisine:'specialty',tiers:['box_lunch','buffet'],price_per_person:9,dietary:['vegan','gf','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:5},
    {id:'sp6',name:'Fruit Tart',description:'Buttery pastry shell with vanilla cream and fresh seasonal fruit',cuisine:'specialty',tiers:['buffet','mix_match'],price_per_person:10,dietary:['nut_free'],available_days:[1,2,3,4,5],active:true,sort_order:6},
    {id:'sp7',name:'Hummus Platter',description:'House-made hummus, baba ganoush, tabbouleh, pita and cruditÃ©s',cuisine:'specialty',tiers:['box_lunch','buffet','mix_match'],price_per_person:12,dietary:['vegan','nut_free','dairy_free'],available_days:[1,2,3,4,5],active:true,sort_order:7},
  ],
  tiers: [
    {id:'box_lunch',name:'Box Lunch',price_min:15,price_max:18,guest_min:100,guest_max:300,description:'Individual packaged meals.',features:['Custom grain bowls or salads','Fresh fruit & dessert','Vegan & GF options labeled','Individual eco-packaging','On-time delivery guaranteed'],is_featured:false},
    {id:'buffet',name:'Buffet Spread',price_min:20,price_max:25,guest_min:100,guest_max:300,description:'Full buffet service.',features:['Hot mains + 3 sides','Soup or salad starter','Dessert included','Full dietary labeling','On-site coordinator option','Eco-compostable packaging'],is_featured:true},
    {id:'mix_match',name:'Mix & Match',price_min:0,price_max:0,guest_min:150,guest_max:300,description:'Choose 2â€“3 cuisines.',features:['Choose 2â€“3 chef cuisines','Perfect for diverse teams','Live chef station option','Branded signage included','Full white-glove service'],is_featured:false},
  ],
  schedule: {},
  last_updated: new Date().toISOString()
};

function getOrInitData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  localStorage.setItem(STORAGE_KEY, JSON.stringify(DEFAULT_DATA));
  return JSON.parse(JSON.stringify(DEFAULT_DATA));
}

function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// B â€” STATE + CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentDate = new Date();
let selectedDateKey = null;
let viewMode = 'month';

const CUISINE_COLORS = {
  sushi:     { bg: '#EEF2FF', text: '#3730A3', dot: '#6366F1', label: 'Sushi' },
  chinese:   { bg: '#FEF2F2', text: '#991B1B', dot: '#EF4444', label: 'Chinese' },
  mexican:   { bg: '#FFF7ED', text: '#9A3412', dot: '#F97316', label: 'Mexican' },
  american:  { bg: '#FFFBEB', text: '#92400E', dot: '#F59E0B', label: 'American' },
  specialty: { bg: '#F0FDF4', text: '#166534', dot: '#22C55E', label: 'Specialty' },
};

const TIER_LABELS = { box_lunch: 'Box Lunch', buffet: 'Buffet', mix_match: 'Mix & Match' };
const DIETARY_LABELS = { vegan:'ğŸŒ± Vegan', gf:'ğŸŒ¾ GF', nut_free:'ğŸ¥œ Nut-Free', dairy_free:'ğŸ¥› Dairy-Free', halal:'â˜ªï¸ Halal' };
const DAY_SHORT = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// C â€” HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatDateKey(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,'0');
  const d = String(date.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

function parseDateKey(key) {
  const [y,m,d] = key.split('-').map(Number);
  return new Date(y, m-1, d);
}

function isToday(date) {
  const now = new Date();
  return date.getFullYear()===now.getFullYear() && date.getMonth()===now.getMonth() && date.getDate()===now.getDate();
}

function getItemsForDate(dateKey, filterCuisine, filterTier) {
  const data = getOrInitData();
  const date = parseDateKey(dateKey);
  const dayOfWeek = date.getDay();

  let items;
  // Check schedule override first
  if (data.schedule && data.schedule[dateKey] && data.schedule[dateKey].length > 0) {
    const ids = new Set(data.schedule[dateKey]);
    items = data.items.filter(i => i.active && ids.has(i.id));
  } else {
    items = data.items.filter(i => i.active && i.available_days.includes(dayOfWeek));
  }

  if (filterCuisine) items = items.filter(i => i.cuisine === filterCuisine);
  if (filterTier) items = items.filter(i => i.tiers.includes(filterTier));
  return items;
}

function getCuisinesForDate(dateKey, filterCuisine, filterTier) {
  const items = getItemsForDate(dateKey, filterCuisine, filterTier);
  return [...new Set(items.map(i => i.cuisine))];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// D â€” MONTH VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMonth() {
  const filterCuisine = document.getElementById('ctrl-cuisine').value;
  const filterTier = document.getElementById('ctrl-tier').value;
  const today = new Date();
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  document.getElementById('cal-title').textContent = `${MONTH_NAMES[month]} ${year}`;

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const daysInPrevMonth = new Date(year, month, 0).getDate();

  let html = '';

  // Day headers
  DAY_SHORT.forEach(d => {
    html += `<div class="cal-day-header">${d}</div>`;
  });

  // Leading empty cells (prev month)
  for (let i = 0; i < firstDay; i++) {
    const d = daysInPrevMonth - firstDay + 1 + i;
    const date = new Date(year, month-1, d);
    const key = formatDateKey(date);
    const cuisines = getCuisinesForDate(key, filterCuisine, filterTier);
    const count = getItemsForDate(key, filterCuisine, filterTier).length;
    html += renderCell(date, key, cuisines, count, true);
  }

  // Current month cells
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const key = formatDateKey(date);
    const cuisines = getCuisinesForDate(key, filterCuisine, filterTier);
    const count = getItemsForDate(key, filterCuisine, filterTier).length;
    html += renderCell(date, key, cuisines, count, false);
  }

  // Trailing empty cells (next month)
  const totalCells = firstDay + daysInMonth;
  const trailingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  for (let i = 1; i <= trailingCells; i++) {
    const date = new Date(year, month+1, i);
    const key = formatDateKey(date);
    const cuisines = getCuisinesForDate(key, filterCuisine, filterTier);
    const count = getItemsForDate(key, filterCuisine, filterTier).length;
    html += renderCell(date, key, cuisines, count, true);
  }

  document.getElementById('cal-grid-wrap').innerHTML = `<div class="cal-grid">${html}</div>`;
}

function renderCell(date, key, cuisines, count, otherMonth) {
  const todayClass = isToday(date) ? ' today' : '';
  const selectedClass = key === selectedDateKey ? ' selected' : '';
  const otherClass = otherMonth ? ' other-month' : '';
  const todayPill = isToday(date) ? '<span class="today-pill">TODAY</span>' : '';
  const dots = cuisines.slice(0,5).map(c =>
    `<div class="cal-dot" style="background:${CUISINE_COLORS[c]?.dot||'#999'};" title="${CUISINE_COLORS[c]?.label||c}"></div>`
  ).join('');
  const countLabel = count > 0 ? `<div class="cal-item-count">${count} item${count!==1?'s':''}</div>` : '';

  return `
    <div class="cal-cell${todayClass}${selectedClass}${otherClass}" onclick="selectDay('${key}')">
      <div class="cal-date-num">${date.getDate()} ${todayPill}</div>
      ${dots ? `<div class="cal-dots">${dots}</div>` : ''}
      ${countLabel}
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// E â€” WEEK VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderWeek() {
  const filterCuisine = document.getElementById('ctrl-cuisine').value;
  const filterTier = document.getElementById('ctrl-tier').value;

  // Find Sunday of current week
  const day = currentDate.getDay();
  const sunday = new Date(currentDate);
  sunday.setDate(currentDate.getDate() - day);

  const weekStart = new Date(sunday);
  const weekEnd = new Date(sunday);
  weekEnd.setDate(sunday.getDate() + 6);
  document.getElementById('cal-title').textContent =
    `${MONTH_NAMES[weekStart.getMonth()]} ${weekStart.getDate()} â€“ ${weekEnd.getDate()}, ${weekEnd.getFullYear()}`;

  let html = '';
  for (let i = 0; i < 7; i++) {
    const date = new Date(sunday);
    date.setDate(sunday.getDate() + i);
    const key = formatDateKey(date);
    const todayClass = isToday(date) ? ' today' : '';
    const selectedClass = key === selectedDateKey ? ' selected' : '';
    const items = getItemsForDate(key, filterCuisine, filterTier);

    const itemsHtml = items.length === 0
      ? `<div class="week-empty">No items</div>`
      : items.slice(0,8).map(item => `
          <div class="week-item">
            <div class="week-dot" style="background:${CUISINE_COLORS[item.cuisine]?.dot||'#999'};"></div>
            <div class="week-item-name">${escHtml(item.name)}</div>
          </div>
        `).join('') + (items.length > 8 ? `<div class="week-empty">+${items.length-8} more</div>` : '');

    html += `
      <div class="week-col${todayClass}${selectedClass}" onclick="selectDay('${key}')">
        <div class="week-col-header">
          <div class="week-col-dayname">${DAY_SHORT[date.getDay()]}</div>
          <div class="week-col-date">${date.getDate()}</div>
        </div>
        <div class="week-col-body">${itemsHtml}</div>
      </div>
    `;
  }

  document.getElementById('cal-grid-wrap').innerHTML = `<div class="week-grid">${html}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// F â€” DAY SELECTION + PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectDay(dateKey) {
  selectedDateKey = dateKey;
  // Re-render the grid to update selected state
  if (viewMode === 'month') renderMonth();
  else renderWeek();
  renderPanel(dateKey);
}

function renderPanel(dateKey) {
  const panelTier = document.getElementById('panel-tier-filter') ? document.getElementById('panel-tier-filter').value : '';
  const panelDietary = document.getElementById('panel-dietary-filter') ? document.getElementById('panel-dietary-filter').value : '';
  const filterCuisine = document.getElementById('ctrl-cuisine').value;

  const date = parseDateKey(dateKey);
  const items = getItemsForDate(dateKey, filterCuisine, '');

  // Apply panel-level filters
  let filtered = items;
  if (panelTier) filtered = filtered.filter(i => i.tiers.includes(panelTier));
  if (panelDietary) filtered = filtered.filter(i => i.dietary.includes(panelDietary));

  const dateStr = date.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'});
  const cuisines = [...new Set(filtered.map(i => i.cuisine))];

  const panel = document.getElementById('cal-panel');

  if (items.length === 0) {
    panel.innerHTML = `
      <div class="panel-header">
        <div class="panel-date">${date.toLocaleDateString('en-US',{weekday:'long', month:'long', day:'numeric'})}</div>
        <div class="panel-meta">No items scheduled</div>
      </div>
      <div class="panel-body">
        <div class="panel-empty">
          <div class="empty-icon">ğŸŒ™</div>
          No menu items available this day.<br/>
          <a href="/admin" style="color:var(--green);font-weight:600;font-size:0.85rem;">Go to Admin to schedule items â†’</a>
        </div>
      </div>
    `;
    return;
  }

  // Group filtered items by cuisine
  const grouped = {};
  filtered.forEach(item => {
    if (!grouped[item.cuisine]) grouped[item.cuisine] = [];
    grouped[item.cuisine].push(item);
  });

  const cuisineOrder = ['sushi','chinese','mexican','american','specialty'];
  const groupedHtml = cuisineOrder
    .filter(c => grouped[c] && grouped[c].length > 0)
    .map(c => {
      const col = CUISINE_COLORS[c] || {};
      const cItems = grouped[c];
      return `
        <div class="panel-cuisine-section">
          <div class="panel-cuisine-header">
            <div class="panel-cuisine-dot" style="background:${col.dot||'#999'};"></div>
            ${col.label || c}
            <span class="panel-cuisine-count">${cItems.length} item${cItems.length!==1?'s':''}</span>
          </div>
          ${cItems.map(item => `
            <div class="panel-item">
              <div class="panel-item-top">
                <div class="panel-item-name">${escHtml(item.name)}</div>
                <div class="panel-item-price">$${item.price_per_person}<span style="font-size:0.7rem;font-weight:400;color:var(--muted);font-family:var(--font-body);">/pp</span></div>
              </div>
              ${item.description ? `<div class="panel-item-desc">${escHtml(item.description)}</div>` : ''}
              <div class="panel-item-tags">
                ${item.dietary.map(d=>`<span class="tag-dietary">${DIETARY_LABELS[d]||d}</span>`).join('')}
                ${item.tiers.map(t=>`<span class="tag-tier">${TIER_LABELS[t]||t}</span>`).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }).join('');

  const friendlyDate = date.toLocaleDateString('en-US',{weekday:'long', month:'long', day:'numeric', year:'numeric'});
  const cuisineList = cuisines.map(c => CUISINE_COLORS[c]?.label || c).join(', ');
  const emailSubject = encodeURIComponent(`Catering Request â€“ ${friendlyDate}`);
  const emailBody = encodeURIComponent(`Hi!\n\nI'd like to book catering for ${friendlyDate}.\n\nCuisine interest: ${cuisineList || 'TBD'}\nGuest count: \nTier (Box Lunch / Buffet / Mix & Match): \nDietary needs: \n\nLooking forward to hearing from you!`);
  const bookHref = `mailto:hello@culinaryblock.com?subject=${emailSubject}&body=${emailBody}`;

  panel.innerHTML = `
    <div class="panel-header">
      <div class="panel-date">${date.toLocaleDateString('en-US',{weekday:'long', month:'long', day:'numeric'})}</div>
      <div class="panel-meta">${filtered.length} item${filtered.length!==1?'s':''} Â· ${cuisines.length} cuisine${cuisines.length!==1?'s':''}</div>
      <div class="panel-filters">
        <select class="panel-filter-select" id="panel-tier-filter" onchange="renderPanel('${dateKey}')">
          <option value="">All Tiers</option>
          <option value="box_lunch" ${panelTier==='box_lunch'?'selected':''}>Box Lunch</option>
          <option value="buffet" ${panelTier==='buffet'?'selected':''}>Buffet</option>
          <option value="mix_match" ${panelTier==='mix_match'?'selected':''}>Mix &amp; Match</option>
        </select>
        <select class="panel-filter-select" id="panel-dietary-filter" onchange="renderPanel('${dateKey}')">
          <option value="">Any Dietary</option>
          <option value="vegan" ${panelDietary==='vegan'?'selected':''}>ğŸŒ± Vegan</option>
          <option value="gf" ${panelDietary==='gf'?'selected':''}>ğŸŒ¾ GF</option>
          <option value="nut_free" ${panelDietary==='nut_free'?'selected':''}>ğŸ¥œ Nut-Free</option>
          <option value="dairy_free" ${panelDietary==='dairy_free'?'selected':''}>ğŸ¥› Dairy-Free</option>
          <option value="halal" ${panelDietary==='halal'?'selected':''}>â˜ªï¸ Halal</option>
        </select>
      </div>
    </div>
    <div class="panel-body">
      ${filtered.length === 0
        ? `<div class="panel-empty"><div class="empty-icon">ğŸ”</div>No items match these filters.</div>`
        : groupedHtml
      }
    </div>
    <div class="panel-book-wrap">
      <a class="btn-book-date" href="${bookHref}">Book This Date â†’</a>
      <div class="btn-book-subtext">Opens email Â· We reply within 24 hours</div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// G â€” CONTROLS + LEGEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setView(mode) {
  viewMode = mode;
  document.getElementById('btn-month').classList.toggle('active', mode==='month');
  document.getElementById('btn-week').classList.toggle('active', mode==='week');
  if (mode === 'month') renderMonth();
  else renderWeek();
}

function renderLegend() {
  document.getElementById('legend').innerHTML = Object.entries(CUISINE_COLORS).map(([key,col]) =>
    `<div class="legend-item">
      <div class="legend-dot" style="background:${col.dot};"></div>
      ${col.label}
    </div>`
  ).join('');
}

document.getElementById('btn-prev').addEventListener('click', () => {
  if (viewMode === 'month') {
    currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1);
    renderMonth();
  } else {
    currentDate = new Date(currentDate);
    currentDate.setDate(currentDate.getDate()-7);
    renderWeek();
  }
});

document.getElementById('btn-next').addEventListener('click', () => {
  if (viewMode === 'month') {
    currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1);
    renderMonth();
  } else {
    currentDate = new Date(currentDate);
    currentDate.setDate(currentDate.getDate()+7);
    renderWeek();
  }
});

document.getElementById('btn-today').addEventListener('click', () => {
  currentDate = new Date();
  if (viewMode === 'month') renderMonth();
  else renderWeek();
  const todayKey = formatDateKey(new Date());
  selectDay(todayKey);
});

document.getElementById('ctrl-cuisine').addEventListener('change', () => {
  if (viewMode === 'month') renderMonth();
  else renderWeek();
  if (selectedDateKey) renderPanel(selectedDateKey);
});

document.getElementById('ctrl-tier').addEventListener('change', () => {
  if (viewMode === 'month') renderMonth();
  else renderWeek();
  if (selectedDateKey) renderPanel(selectedDateKey);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// H â€” INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
getOrInitData();
renderLegend();
renderMonth();
// Auto-select today
const todayKey = formatDateKey(new Date());
selectDay(todayKey);
</script>
</body>
</html>
